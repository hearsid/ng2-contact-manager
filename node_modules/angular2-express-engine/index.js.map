{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../modules/express-engine/src/index.ts"],"names":[],"mappings":";AAAA,IAAM,EAAE,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AAElC,qBAAyC,yBAAyB,CAAC,CAAA;AAMnE;IACE,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,GAAG,OAAO,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;AAC7E,CAAC;AA8BD,sBAA6B,OAAa;IACxC,OAAO,GAAG,OAAO,IAAI,EAAE,CAAC;IACxB,IAAI,KAAK,GAAG,EACX,CAAC;IACF,IAAI,QAAQ,GAAG;QACb,UAAU,EAAE,IAAI;QAChB,IAAI,EAAE,KAAK;QACX,YAAY,EAAE,IAAI;QAClB,EAAE,EAAE,cAAM,OAAA,EAAE,EAAE,EAAJ,CAAI;QACd,QAAQ,EAAE,UAAC,SAAS,IAAK,OAAA,+BAAwB,CAAC,SAAS,CAAC,EAAnC,CAAmC;QAC5D,SAAS,EAAE,EAAE;QACb,QAAQ,EAAE,IAAI;KACf,CAAC;IACF,QAAQ,CAAC,UAAU,GAAG,CAAC,YAAY,IAAI,OAAO,CAAC,GAAI,OAAO,CAAC,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAC;IAC5F,QAAQ,CAAC,IAAI,GAAG,CAAC,MAAM,IAAI,OAAO,CAAC,GAAI,OAAO,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC;IACpE,QAAQ,CAAC,YAAY,GAAG,CAAC,cAAc,IAAI,OAAO,CAAC,GAAI,OAAO,CAAC,YAAY,GAAG,QAAQ,CAAC,YAAY,CAAC;IACpG,QAAQ,CAAC,EAAE,GAAG,OAAO,CAAC,EAAE,IAAI,QAAQ,CAAC,EAAE,CAAC;IACxC,QAAQ,CAAC,QAAQ,GAAI,OAAO,CAAC,QAAQ,IAAI,QAAQ,CAAC,QAAQ,CAAC;IAC3D,IAAI,UAAU,GAAG,OAAO,CAAC,QAAQ,IAAI,QAAQ,CAAC,QAAQ,CAAC;IACvD,IAAI,WAAW,GAAG,OAAO,CAAC,SAAS,IAAI,QAAQ,CAAC,SAAS,CAAC;IAC1D,OAAO,QAAQ,CAAC,SAAS,CAAC;IAC1B,OAAO,QAAQ,CAAC,QAAQ,CAAC;IAEzB,IAAM,WAAW,GAAQ,UAAU,CAAC,WAAW,CAAC,CAAC;IACjD,IAAI,IAAI,CAAC;IACT,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,IAAI,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC;QAC7C,IAAI,GAAG,WAAW,CAAC,kBAAkB,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAA;IAC1D,CAAC;IAED,MAAM,CAAC,uBAAuB,QAAgB,EAAE,IAAyD,EAAE,IAAe;QAA1E,oBAAyD,GAAzD,SAA6B,QAAQ,EAAE,QAAQ,CAAC,QAAQ,EAAC;QACvG,IAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,IAAI,QAAQ,CAAC,QAAQ,CAAC;QACpD,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;YACd,MAAM,IAAI,KAAK,CAAC,gKAAgK,CAAC,CAAA;QACnL,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;YAC3B,MAAM,IAAI,KAAK,CAAC,wHAAwH,CAAC,CAAC;QAC5I,CAAC;QACD,IAAI,MAAM,GAAG,KAAK,CAAC;QACnB,EAAE,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;YACb,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,cAAM,OAAA,MAAM,GAAG,IAAI,EAAb,CAAa,CAAC,CAAC;QAC5C,CAAC;QAED,IAAM,KAAK,GAAG,MAAM,CAAC,MAAM,CAAC;YAC1B,IAAI,MAAM,KAAK,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;YAC/B,IAAI,MAAM,CAAC,GAAG,IAAI,MAAM,GAAG,GAAG,CAAC,CAAC,CAAC;YAEjC,IAAI,UAAU,KAAK,MAAM,CAAC,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,GAAG,CAAC,WAAW,CAAA,CAAC,CAAC;YACnE,IAAI,UAAU,CAAC,IAAI,IAAK,CAAC;YAEzB,IAAI,SAAS,KAAK,MAAM,CAAC,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAA,CAAC,CAAC;YAC9D,IAAI,SAAS,CAAC,IAAI,IAAK,CAAC;YAExB,IAAI,OAAO,KAAK,MAAM,CAAC,IAAI,CAAC,OAAO,IAAI,GAAG,CAAA,CAAC,CAAC;YAC5C,IAAI,OAAO,CAAC,IAAI,IAAK,CAAC;YAEtB,IAAI,MAAM,KAAK,MAAM,CAAC,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,MAAM,CAAA,CAAC,CAAC;YAC9D,IAAI,MAAM,CAAC,IAAI,IAAK,CAAC;SACtB,EAAE,IAAI,CAAC,CAAC;QAET,qBAAqB,OAAO;YAC1B,IAAM,QAAQ,GAAW,OAAO,CAAC,QAAQ,EAAE,CAAC;YAG5C,KAAK,CAAC,QAAQ,GAAG,QAAQ,CAAC;YAC1B,KAAK,CAAC,QAAQ,GAAG,QAAQ,CAAC;YAC1B,KAAK,CAAC,aAAa,GAAG,cAAM,OAAA,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,EAA1B,CAA0B,CAAC;YAEvD,IAAM,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC;gBAC7B,IAAI,EAAE,mBAAmB;gBACzB,UAAU,EAAE,KAAK;aAClB,CAAC,CAAC;YAGH,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,cAAM,OAAA,CAAC,QAAQ,CAAC,UAAU;gBACxC,WAAW,CAAC,eAAe,CAAC,QAAQ,EAAE,KAAK,CAAC;gBAC5C,WAAW,CAAC,sBAAsB,CAAC,QAAQ,EAAE,KAAK,CAAC,CACpD;iBACE,IAAI,CAAC,UAAA,IAAI;gBACR,EAAE,CAAC,CAAC,OAAO,IAAI,KAAK,QAAQ,IAAI,MAAM,CAAC,CAAC,CAAC;oBACvC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;gBAC9B,CAAC;gBACD,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;YACnB,CAAC,CAAC;iBACD,KAAK,CAAC,UAAA,CAAC;gBACN,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;gBAErB,IAAI,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;YACvB,CAAC,CAAC,EAdkB,CAclB,CAAC,CAAC;QACR,CAAC;QAGD,IAAI,CAAC;YAEH,EAAE,CAAC,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;gBACpB,MAAM,CAAC,WAAW,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC;YACtC,CAAC;YACD,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,UAAC,GAAG,EAAE,OAAO;gBACjC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;oBACR,MAAM,GAAG,IAAI,CAAC;oBACd,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACnB,CAAC;gBACD,KAAK,CAAC,QAAQ,CAAC,GAAG,OAAO,CAAC;gBAC1B,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;YAC9B,CAAC,CAAC,CAAC;QAEL,CAAE;QAAA,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YACX,MAAM,GAAG,IAAI,CAAC;YACd,IAAI,CAAC,CAAC,CAAC,CAAC;QACV,CAAC;IACH,CAAC,CAAC;AACJ,CAAC;AA9Ge,oBAAY,eA8G3B,CAAA","sourcesContent":["const fs = require('graceful-fs');\n\nimport { platformUniversalDynamic } from 'angular2-universal/node';\n\nimport { PrebootOptions } from 'preboot';\n\ndeclare var Zone: any;\n// @internal\nfunction s4() {\n  return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);\n}\n\nexport interface ExpressEngineConfig {\n  document?: string;\n  DOCUMENT?: string;\n  cancelHandler?: () => boolean;\n  CANCEL_HANDLER?: () => boolean;\n  req?: any;\n  REQ?: any;\n  res?: any;\n  RES?: any;\n  time?: boolean;\n  TIME?: boolean;\n  id?: string;\n  ID?: string;\n  ngModule?: any;\n  precompile?: boolean;\n  preboot?: PrebootOptions;\n  cancel?: boolean;\n  CANCEL?: boolean;\n  requestUrl?: string;\n  REQUEST_URL?: string;\n  originUrl?: string;\n  ORIGIN_URL?: string;\n  baseUrl?: string;\n  BASE_URL?: string;\n  cookie?: string;\n  COOKIE?: string;\n}\n\nexport function createEngine(options?: any) {\n  options = options || {};\n  var cache = {\n  };\n  var _options = {\n    precompile: true,\n    time: false,\n    asyncDestroy: true,\n    id: () => s4(),\n    platform: (providers) => platformUniversalDynamic(providers),\n    providers: [],\n    ngModule: null\n  };\n  _options.precompile = ('precompile' in options) ?  options.precompile : _options.precompile;\n  _options.time = ('time' in options) ?  options.time : _options.time;\n  _options.asyncDestroy = ('asyncDestroy' in options) ?  options.asyncDestroy : _options.asyncDestroy;\n  _options.id = options.id || _options.id;\n  _options.ngModule =  options.ngModule || _options.ngModule;\n  var __platform = options.platform || _options.platform;\n  var __providers = options.providers || _options.providers;\n  delete _options.providers;\n  delete _options.platform;\n\n  const platformRef: any = __platform(__providers);\n  var prom;\n  if (_options.ngModule && _options.precompile) {\n    prom = platformRef.cacheModuleFactory(_options.ngModule)\n  }\n\n  return function expressEngine(filePath: string, data: ExpressEngineConfig = {ngModule: _options.ngModule}, done?: Function) {\n    const ngModule = data.ngModule || _options.ngModule;\n    if (!ngModule) {\n      throw new Error('Please provide your main module as ngModule for example res.render(\"index\", {ngModule: MainModule}) or in the engine as createEngine({ ngModule: MainModule })')\n    }\n    if (!data.req || !data.res) {\n      throw new Error('Please provide the req, res arguments (request and response objects from express) in res.render(\"index\", { req, res })');\n    }\n    var cancel = false;\n    if (data.req) {\n      data.req.on('close', () => cancel = true);\n    }\n    // defaults\n    const _data = Object.assign({\n      get cancel() { return cancel; },\n      set cancel(val) { cancel = val; },\n\n      get requestUrl() { return data.requestUrl || data.req.originalUrl },\n      set requestUrl(_val) {  },\n\n      get originUrl() { return data.originUrl || data.req.hostname },\n      set originUrl(_val) {  },\n\n      get baseUrl() { return data.baseUrl || '/' },\n      set baseUrl(_val) {  },\n\n      get cookie() { return data.cookie || data.req.headers.cookie },\n      set cookie(_val) {  },\n    }, data);\n\n    function readContent(content) {\n      const DOCUMENT: string = content.toString();\n      // TODO(gdi2290): breaking change for context globals\n      // _data.document = parseDocument(document);\n      _data.document = DOCUMENT;\n      _data.DOCUMENT = DOCUMENT;\n      _data.cancelHandler = () => Zone.current.get('cancel');\n\n      const zone = Zone.current.fork({\n        name: 'UNIVERSAL request',\n        properties: _data\n      });\n\n      // convert to string\n      return zone.run(() => (_options.precompile ?\n        platformRef.serializeModule(ngModule, _data) :\n        platformRef.serializeModuleFactory(ngModule, _data)\n      )\n        .then(html => {\n          if (typeof html !== 'string' || cancel) {\n            return done(null, DOCUMENT);\n          }\n          done(null, html);\n        })\n        .catch(e => {\n          console.log(e.stack);\n          // if server fail then return client html\n          done(null, DOCUMENT);\n        }));\n    }\n\n    // read file on disk\n    try {\n\n      if (cache[filePath]) {\n        return readContent(cache[filePath]);\n      }\n      fs.readFile(filePath, (err, content) => {\n        if (err) {\n          cancel = true;\n          return done(err);\n        }\n        cache[filePath] = content;\n        return readContent(content);\n      });\n\n    } catch (e) {\n      cancel = true;\n      done(e);\n    }\n  };\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}